---
import VideoGrid from '../components/VideoGrid';
import { loadFromCache } from '../utils/googleSheetsManager';

// Prefer reading the server-side cache for SSR so the page renders with data
// (fallback to the API fetch only if the cache is empty). Add logs for debug.
let works = [];
try {
  const cached = await loadFromCache();
  if (cached && Array.isArray(cached) && cached.length > 0) {
    works = cached;
    console.log('[theatre-works.astro] loaded works from cache count=', works.length);
  } else {
    try {
      const res = await fetch('/api/theatre-works');
      if (res.ok) {
        works = await res.json();
        console.log('[theatre-works.astro] fetched works from API count=', Array.isArray(works) ? works.length : 0);
      } else {
        console.warn('[theatre-works.astro] API returned non-ok', res.status);
      }
    } catch (e) {
      console.warn('[theatre-works.astro] fetch to /api/theatre-works failed', e?.message ?? e);
    }
  }
} catch (e) {
  console.error('[theatre-works.astro] error loading works', e?.message ?? e);
  works = [];
}

const totalVideos = Array.isArray(works) ? works.reduce((s, w) => s + (w.scenes?.length || 0), 0) : 0;
const currentWork = (Array.isArray(works) && works.length > 0) ? works[0] : null;
const credits = [];
---

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="stylesheet" href="/theatre-works.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Baptiste Le Chapelain</title>
    <style>
      @import '../components/CreditsPanel.css';
      @import '../components/VUMeter.css';
    </style>
  </head>
  <body>
    <nav class="main-nav">
      <div class="nav-container">
        <div class="nav-links">
          <a href="/theatre-works" class="nav-link home-link active" aria-label="theatre"><span class="desktop-label">music for theatre</span><span class="mobile-label">theatre</span></a>
          <a href="/music" class="nav-link">music</a>
          <a href="/audiovisual" class="nav-link">audiovisual</a>
          <a href="/contact" class="nav-link">contact</a>
        </div>
      </div>
    </nav>

    <div class="theatre-works">
      <div class="fixed-viewer">
        <div class="viewer-container">
          <div class="video-section full-width">
            {works.length === 0 ? (
              <div class="loading">
                <p>No works found</p>
              </div>
            ) : (
              <VideoGrid works={works} client:only="react" />
            )}
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
